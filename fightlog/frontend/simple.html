<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FightLog - Kampfsporterfolge digital erfassen</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- CSS -->
    <link rel="stylesheet" href="./styles/main.css">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Bridge for early alerts (queues calls until notify.js is ready) -->
    <script>
        (function(){
            if (!window._notifyQueue) window._notifyQueue = [];
            // queue native alert calls
            const _nativeAlert = window.alert;
            window.alert = function(msg){
                try { window._notifyQueue.push(msg); } catch(e){ /* fallback */ _nativeAlert(msg); }
            };
        })();
    </script>
    <!-- Passkey Manager -->
    <script src="./passkey.js"></script>
    <script src="./notify.js"></script>
    
    <style>
        /* Apple-√§hnliches Design */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
            line-height: 1.47;
            font-size: 17px;
            font-weight: 400;
            letter-spacing: -0.022em;
        }
        
        .simple-login {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: #f5f5f7;
        }
        
        .login-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 18px;
            padding: 48px 40px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .login-card h1 {
            text-align: center;
            margin-bottom: 8px;
            color: #1d1d1f;
            font-size: 32px;
            font-weight: 600;
            letter-spacing: -0.003em;
        }
        
        .login-subtitle {
            text-align: center;
            margin-bottom: 40px;
            color: #86868b;
            font-size: 17px;
            font-weight: 400;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 400;
            color: #1d1d1f;
            font-size: 17px;
        }
        
        .form-group input {
            width: 100%;
            padding: 16px 20px;
            border: 1px solid #d2d2d7;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 400;
            background: rgba(255, 255, 255, 0.8);
            transition: all 0.2s ease;
            font-family: inherit;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #007aff;
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .password-container {
            position: relative;
        }
        
        .password-toggle {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #86868b;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .password-toggle:hover {
            background: rgba(0, 0, 0, 0.05);
            color: #1d1d1f;
        }
        
        .btn {
            width: 100%;
            padding: 16px 24px;
            background: #007aff;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
            margin-bottom: 12px;
        }
        
        .btn:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: rgba(0, 0, 0, 0.04);
            color: #1d1d1f;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .btn-secondary:hover {
            background: rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background: #ff3b30;
        }
        
        .btn-danger:hover {
            background: #d70015;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: #34c759;
        }
        
        .btn-success:hover {
            background: #248a3d;
            transform: translateY(-1px);
        }
        
        .btn-purple {
            background: #af52de;
        }
        
        .btn-purple:hover {
            background: #8e44ad;
            transform: translateY(-1px);
        }
        
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        
        .button-group .btn {
            flex: 1;
            margin-bottom: 0;
        }
        
        .demo-info {
            text-align: center;
            margin-top: 32px;
            font-size: 15px;
            color: #86868b;
            line-height: 1.4;
        }
        
        .demo-info code {
            background: rgba(0, 0, 0, 0.05);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-size: 13px;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 18px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .modal-header {
            padding: 24px 24px 16px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .modal-header h2 {
            margin: 0;
            color: #1d1d1f;
            font-size: 22px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            font-size: 20px;
            color: #86868b;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .close-btn:hover {
            background: rgba(0, 0, 0, 0.05);
            color: #1d1d1f;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .login-card {
                padding: 32px 24px;
                margin: 16px;
            }
            
            .login-card h1 {
                font-size: 28px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .modal-content {
                width: 95%;
                margin: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="simple-login">
        <div class="login-card">
            <h1>ü•ã FightLog</h1>
            <p class="login-subtitle">Kampfsporterfolge digital erfassen</p>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Benutzername</label>
                    <input type="text" id="username" name="username" value="admin" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Passwort</label>
                    <div class="password-container">
                        <input type="password" id="password" name="password" value="admin123" required>
                        <button type="button" onclick="togglePasswordVisibility()" class="password-toggle">
                            <i id="passwordToggleIcon" class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                
                <button type="submit" class="btn">
                    Anmelden
                </button>
                
                <div class="button-group">
                    <button type="button" class="btn btn-danger" onclick="showForgotPassword()">
                        Passwort vergessen
                    </button>
                    
                    <button type="button" class="btn btn-success" onclick="showRegisterForm()">
                        Registrieren
                    </button>
                </div>
                
                <button type="button" class="btn btn-purple" id="passkeyRegisterBtn" onclick="registerPasskey()" style="display: none;">
                    Passkey registrieren
                </button>
            </form>
            
            <div class="demo-info">
                <p><strong>Test-Logins:</strong></p>
                <p><strong>Admin</strong> ‚Äî Benutzername: <code>admin</code> ‚Äî Passwort: <code>admin123</code></p>
                <p><strong>Trainer</strong> ‚Äî Benutzername: <code>trainer</code> ‚Äî Passwort: <code>trainer123</code></p>
                <p><strong>Sch√ºler</strong> ‚Äî Benutzername: <code>schueler</code> ‚Äî Passwort: <code>schueler123</code></p>
            </div>
        </div>
    </div>

    <!-- Passwort vergessen Modal -->
    <div id="forgotPasswordModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Passwort zur√ºcksetzen</h2>
                <button onclick="closeForgotPassword()" class="close-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <p>Geben Sie Ihre E-Mail-Adresse ein, um ein neues Passwort anzufordern:</p>
                
                <div class="form-group">
                    <label for="resetEmail">E-Mail-Adresse</label>
                    <input type="email" id="resetEmail" placeholder="ihre@email.com">
                </div>
                
                <div class="button-group">
                    <button onclick="sendPasswordReset()" class="btn">
                        Zur√ºcksetzen
                    </button>
                    <button onclick="closeForgotPassword()" class="btn btn-secondary">
                        Abbrechen
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Registrierung Modal -->
    <div id="registerModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Neuen Account erstellen</h2>
                <button onclick="closeRegisterForm()" class="close-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <form id="registerForm">
                    <div class="form-group">
                        <label for="regUsername">Benutzername</label>
                        <input type="text" id="regUsername" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="regEmail">E-Mail-Adresse</label>
                        <input type="email" id="regEmail" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="regPassword">Passwort</label>
                        <div class="password-container">
                            <input type="password" id="regPassword" required>
                            <button type="button" onclick="toggleRegisterPasswordVisibility()" class="password-toggle">
                                <i id="registerPasswordToggleIcon" class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="regPasswordConfirm">Passwort best√§tigen</label>
                        <input type="password" id="regPasswordConfirm" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="regRole">Rolle</label>
                        <select id="regRole" required style="width: 100%; padding: 16px 20px; border: 1px solid #d2d2d7; border-radius: 12px; font-size: 17px; background: rgba(255, 255, 255, 0.8); font-family: inherit;">
                            <option value="schueler" selected>Sch√ºler (Standard)</option>
                        </select>
                        <p style="margin-top: 8px; font-size: 14px; color: #86868b;">
                            Neue Accounts werden standardm√§√üig als Sch√ºler erstellt. Administratoren k√∂nnen sp√§ter die Rechte anpassen.
                        </p>
                    </div>
                    
                    <div class="button-group">
                        <button type="submit" class="btn btn-success">
                            Account erstellen
                        </button>
                        <button type="button" onclick="closeRegisterForm()" class="btn btn-secondary">
                            Abbrechen
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Pr√ºfe ob bereits authentifiziert
        function checkExistingAuth() {
            const isAuthenticated = localStorage.getItem('fightlog_authenticated');
            if (isAuthenticated) {
                window.location.href = 'index.html';
            }
        }
        
        // Pr√ºfe auf Passkey-Verf√ºgbarkeit
        function checkPasskeyAvailability() {
            const hasPasskey = localStorage.getItem('fightlog_passkey_available');
            if (hasPasskey) {
                showPasskeyOption();
            }
        }
        
        // Zeige Passkey-Option an
        function showPasskeyOption() {
            const passkeyButton = document.createElement('button');
            passkeyButton.type = 'button';
            passkeyButton.className = 'btn';
            passkeyButton.style.marginTop = '1rem';
            passkeyButton.style.backgroundColor = '#10b981';
            passkeyButton.innerHTML = '<i class="fas fa-key"></i> Mit Passkey anmelden';
            passkeyButton.onclick = attemptPasskeyLogin;
            
            const form = document.getElementById('loginForm');
            form.parentNode.insertBefore(passkeyButton, form.nextSibling);
        }
        
        // Versuche Passkey-Anmeldung
        async function attemptPasskeyLogin() {
            const button = event.target;
            const originalText = button.innerHTML;
            
            try {
                // Zeige Ladeindikator
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Passkey wird √ºberpr√ºft...';
                button.disabled = true;
                
                // Pr√ºfe verf√ºgbare Passkeys
                const availablePasskeys = window.passkeyManager.listPasskeys();
                if (availablePasskeys.length === 0) {
                    throw new Error('Keine Passkeys registriert. Bitte registrieren Sie zuerst einen Passkey.');
                }
                
                // Verwende den ersten verf√ºgbaren Passkey (in echter App w√ºrde Benutzer ausw√§hlen)
                const username = availablePasskeys[0];
                
                // F√ºhre echte WebAuthn-Authentifizierung durch
                const result = await window.passkeyManager.authenticateWithPasskey(username);
                
                if (result.success) {
                    // Speichere Authentifizierung
                    localStorage.setItem('fightlog_authenticated', 'true');
                    localStorage.setItem('fightlog_user', JSON.stringify({
                        username: username,
                        role: 'admin', // Standardrolle f√ºr Passkey-Benutzer
                        authMethod: 'passkey'
                    }));
                    await notify.alert('Passkey-Anmeldung erfolgreich! Weiterleitung zur Hauptanwendung...');
                    window.location.href = 'index.html';
                } else {
                    throw new Error('Passkey-Authentifizierung fehlgeschlagen');
                }
                
            } catch (error) {
                console.error('Passkey-Anmeldung fehlgeschlagen:', error);
                await notify.alert('Passkey-Anmeldung fehlgeschlagen: ' + error.message + '\n\nBitte verwenden Sie die normale Anmeldung.');
            } finally {
                // Stelle Button wieder her
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        // Registriere neuen Passkey
        async function registerPasskey() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Pr√ºfe zuerst registrierte Benutzer
            const registeredUsers = JSON.parse(localStorage.getItem('fightlog_registered_users') || '{}');
            const registeredUser = registeredUsers[username];
            
            let validUser = null;
            
            if (registeredUser && registeredUser.password === password) {
                validUser = registeredUser;
            } else {
                // Fallback zu Test-Logins
                const validLogins = [
                    { username: 'admin', password: 'admin123', role: 'admin' },
                    { username: 'trainer', password: 'trainer123', role: 'trainer' },
                    { username: 'schueler', password: 'schueler123', role: 'schueler' }
                ];
                
                const validLogin = validLogins.find(login => 
                    login.username === username && login.password === password
                );
                
                if (validLogin) {
                    validUser = validLogin;
                }
            }
            
            if (!validUser) {
                await notify.alert('Bitte melden Sie sich zuerst mit g√ºltigen Anmeldedaten an, bevor Sie einen Passkey registrieren.');
                return;
            }
            
            try {
                const result = await window.passkeyManager.registerPasskey(username);
                
                if (result.success) {
                    await notify.alert('Passkey erfolgreich registriert! Sie k√∂nnen sich jetzt mit dem Passkey anmelden.');
                    // Aktualisiere UI
                    checkPasskeyAvailability();
                } else {
                    throw new Error('Passkey-Registrierung fehlgeschlagen');
                }
                
            } catch (error) {
                console.error('Passkey-Registrierung fehlgeschlagen:', error);
                await notify.alert('Passkey-Registrierung fehlgeschlagen: ' + error.message);
            }
        }
        
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Pr√ºfe zuerst registrierte Benutzer
            const registeredUsers = JSON.parse(localStorage.getItem('fightlog_registered_users') || '{}');
            const registeredUser = registeredUsers[username];
            
            if (registeredUser && registeredUser.password === password) {
                // Registrierter Benutzer gefunden
                localStorage.setItem('fightlog_authenticated', 'true');
                localStorage.setItem('fightlog_user', JSON.stringify({
                    username: registeredUser.username,
                    role: registeredUser.role,
                    email: registeredUser.email,
                    authMethod: 'password'
                }));
                await notify.alert(`Login erfolgreich! ${registeredUser.role.charAt(0).toUpperCase() + registeredUser.role.slice(1)} angemeldet. Weiterleitung zur Hauptanwendung...`);
                window.location.href = 'index.html';
                return;
            }
            
            // Fallback zu Test-Logins
            const validLogins = [
                { username: 'admin', password: 'admin123', role: 'admin' },
                { username: 'trainer', password: 'trainer123', role: 'trainer' },
                { username: 'schueler', password: 'schueler123', role: 'schueler' }
            ];
            
            const validLogin = validLogins.find(login => 
                login.username === username && login.password === password
            );
            
            if (validLogin) {
                // Speichere Authentifizierung
                localStorage.setItem('fightlog_authenticated', 'true');
                localStorage.setItem('fightlog_user', JSON.stringify({
                    username: validLogin.username,
                    role: validLogin.role,
                    authMethod: 'password'
                }));
                await notify.alert(`Login erfolgreich! ${validLogin.role.charAt(0).toUpperCase() + validLogin.role.slice(1)} angemeldet. Weiterleitung zur Hauptanwendung...`);
                window.location.href = 'index.html';
            } else {
                await notify.alert('Falsche Anmeldedaten! Verwende einen der Test-Logins oder registriere einen neuen Account.');
            }
        });
        
        // Passwort-Sichtbarkeit umschalten
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('password');
            const toggleIcon = document.getElementById('passwordToggleIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.className = 'fas fa-eye-slash';
            } else {
                passwordInput.type = 'password';
                toggleIcon.className = 'fas fa-eye';
            }
        }
        
        // Registrierung Passwort-Sichtbarkeit umschalten
        function toggleRegisterPasswordVisibility() {
            const passwordInput = document.getElementById('regPassword');
            const toggleIcon = document.getElementById('registerPasswordToggleIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.className = 'fas fa-eye-slash';
            } else {
                passwordInput.type = 'password';
                toggleIcon.className = 'fas fa-eye';
            }
        }
        
        // Passwort vergessen Modal anzeigen
        function showForgotPassword() {
            document.getElementById('forgotPasswordModal').style.display = 'block';
        }
        
        // Passwort vergessen Modal schlie√üen
        function closeForgotPassword() {
            document.getElementById('forgotPasswordModal').style.display = 'none';
            document.getElementById('resetEmail').value = '';
        }
        
        // Passwort zur√ºcksetzen senden
        async function sendPasswordReset() {
            const email = document.getElementById('resetEmail').value;

            if (!email) {
                await notify.alert('Bitte geben Sie eine E-Mail-Adresse ein.');
                return;
            }

            // Zeige Hinweis f√ºr Admin-Kontakt
            await notify.alert(`Passwort vergessen?\n\nBitte wenden Sie sich an einen Administrator.\n\nAdministratoren k√∂nnen Passw√∂rter f√ºr alle Benutzer zur√ºcksetzen und verwalten.\n\nKontaktieren Sie Ihren Trainer oder einen Admin der Kampfsportschule.`);
            closeForgotPassword();
        }
        
        // Registrierung Modal anzeigen
        function showRegisterForm() {
            document.getElementById('registerModal').style.display = 'block';
        }
        
        // Registrierung Modal schlie√üen
        function closeRegisterForm() {
            document.getElementById('registerModal').style.display = 'none';
            document.getElementById('registerForm').reset();
        }
        
        // Registrierung verarbeiten
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('regUsername').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const passwordConfirm = document.getElementById('regPasswordConfirm').value;
            const role = document.getElementById('regRole').value;
            
            // Validierung
            if (!username || !email || !password || !passwordConfirm) {
                await notify.alert('Bitte f√ºllen Sie alle Felder aus.');
                return;
            }

            if (password !== passwordConfirm) {
                await notify.alert('Die Passw√∂rter stimmen nicht √ºberein.');
                return;
            }

            if (password.length < 6) {
                await notify.alert('Das Passwort muss mindestens 6 Zeichen lang sein.');
                return;
            }
            
            // Pr√ºfe ob Benutzername bereits existiert
            const existingUsers = JSON.parse(localStorage.getItem('fightlog_registered_users') || '{}');
            if (existingUsers[username]) {
                await notify.alert('Dieser Benutzername ist bereits vergeben.');
                return;
            }
            
            // Speichere neuen Benutzer
            existingUsers[username] = {
                username: username,
                email: email,
                password: password, // In echter App w√ºrde hier ein Hash gespeichert
                role: role,
                createdAt: new Date().toISOString()
            };
            
            localStorage.setItem('fightlog_registered_users', JSON.stringify(existingUsers));
            
            await notify.alert(`Account erfolgreich erstellt!\n\nBenutzername: ${username}\nRolle: ${role}\n\nSie k√∂nnen sich jetzt anmelden.`);
            closeRegisterForm();
            
            // Zeige Passkey-Registrierung Button an, da jetzt ein Account existiert
            checkPasskeyAvailability();
        });
        
        // Pr√ºfe ob registrierte Benutzer existieren (f√ºr Passkey-Button)
        function checkRegisteredUsers() {
            const existingUsers = JSON.parse(localStorage.getItem('fightlog_registered_users') || '{}');
            const hasRegisteredUsers = Object.keys(existingUsers).length > 0;
            
            // Zeige Passkey-Button nur wenn registrierte Benutzer existieren
            const passkeyBtn = document.getElementById('passkeyRegisterBtn');
            if (hasRegisteredUsers) {
                passkeyBtn.style.display = 'block';
            } else {
                passkeyBtn.style.display = 'none';
            }
        }
        
        // Initialisierung
        checkExistingAuth();
        checkPasskeyAvailability();
        checkRegisteredUsers();
    </script>
</body>
</html> 