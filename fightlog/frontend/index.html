<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FightLog - Kampfsporterfolge digital erfassen</title>
    
    <!-- Vue.js CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        (function(){
            if (!window._notifyQueue) window._notifyQueue = [];
            const _nativeAlert = window.alert;
            window.alert = function(msg){
                try { window._notifyQueue.push(msg); } catch(e){ _nativeAlert(msg); }
            };
        })();
    </script>
    <script>
        // Fallback für Vue.js
        if (typeof Vue === 'undefined') {
            console.error('Vue.js konnte nicht geladen werden');
            document.body.innerHTML = '<div style="padding: 20px; text-align: center;"><h1>FightLog</h1><p>Vue.js konnte nicht geladen werden. Bitte überprüfe deine Internetverbindung.</p></div>';
        }
    </script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- CSS -->
    <link rel="stylesheet" href="./styles/main.css?v=20250127">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Passkey Manager -->
    <script src="./passkey.js"></script>
    <script src="./notify.js"></script>
</head>
<body>
    <div id="app">
        <!-- Hauptanwendung wird hier gerendert -->
    </div>
    
    <!-- JavaScript -->
    <script>
        // Prüfe ob Benutzer bereits authentifiziert ist oder Passkey verfügbar
        function checkAuthentication() {
            // Prüfe auf gespeicherte Authentifizierung
            const isAuthenticated = localStorage.getItem('fightlog_authenticated');
            const hasPasskey = localStorage.getItem('fightlog_passkey_available');
            
            // Wenn nicht authentifiziert und kein Passkey verfügbar, zur Anmeldeseite weiterleiten
            if (!isAuthenticated && !hasPasskey) {
                window.location.href = 'simple.html?v=' + Date.now();
                return;
            }
            
            // Wenn Passkey verfügbar, versuche automatische Anmeldung
            if (hasPasskey && !isAuthenticated) {
                attemptPasskeyLogin();
                return;
            }
            
            // Wenn authentifiziert, Hauptanwendung laden
            if (isAuthenticated) {
                loadMainApp();
            }
        }
        
        // Versuche Passkey-Anmeldung
        async function attemptPasskeyLogin() {
            try {
                // Prüfe verfügbare Passkeys
                const availablePasskeys = window.passkeyManager.listPasskeys();
                if (availablePasskeys.length === 0) {
                    console.log('Keine Passkeys verfügbar, weiter zur Anmeldeseite');
                    window.location.href = 'simple.html?v=' + Date.now();
                    return;
                }
                
                // Zeige Passkey-Anmeldung an
                const usePasskey = await notify.confirm('Passkey verfügbar! Möchten Sie sich mit Passkey anmelden?');
                
                if (usePasskey) {
                    // Verwende den ersten verfügbaren Passkey
                    const username = availablePasskeys[0];
                    
                    // Führe echte WebAuthn-Authentifizierung durch
                    const result = await window.passkeyManager.authenticateWithPasskey(username);
                    
                    if (result.success) {
                        localStorage.setItem('fightlog_authenticated', 'true');
                        localStorage.setItem('fightlog_user', JSON.stringify({
                            username: username,
                            role: 'admin', // Standardrolle für Passkey-Benutzer
                            authMethod: 'passkey'
                        }));
                        loadMainApp();
                    } else {
                        window.location.href = 'simple.html?v=' + Date.now();
                    }
                } else {
                    window.location.href = 'simple.html?v=' + Date.now();
                }
            } catch (error) {
                console.error('Passkey-Anmeldung fehlgeschlagen:', error);
                window.location.href = 'simple.html?v=' + Date.now();
            }
        }
        
        // Lade die Hauptanwendung
        function loadMainApp() {
            const script = document.createElement('script');
            script.src = './main.js';
            document.body.appendChild(script);
        }
        
        // Starte Authentifizierungsprüfung
        checkAuthentication();
    </script>
</body>
</html> 